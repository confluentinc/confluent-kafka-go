version: v1.0
name: 'confluent-kafka-go build pipeline'
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1
global_job_config:
  env_vars:
    - name: LIBRDKAFKA_VERSION
      value: v2.0.2
  prologue:
    commands:
      - checkout
blocks:
  - name: "Go 1.19 OSX bundled librdkafka"
    dependencies: [ ]
    task:
      agent:
        machine:
          type: s1-prod-macos
      prologue:
        commands:
          - sem-version go 1.19
          - export GOPATH=$(go env GOPATH)
          - export PATH="$PATH:$GOPATH/bin"
          - export PKG_CONFIG_PATH="/usr/local/opt/openssl/lib/pkgconfig:$HOME/confluent-kafka-go/tmp-build/lib/pkgconfig"
          - export LD_LIBRARY_PATH="$HOME/confluent-kafka-go/tmp-build/lib"
          - export DYLD_LIBRARY_PATH="$HOME/confluent-kafka-go/tmp-build/lib"
          - rm -rf tmp-build
          - go install golang.org/x/lint/golint@latest && touch .do_lint
          - /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
          - brew install docker
          - docker --version
          - docker compose up --help
      jobs:
        - name: "Dynamic Build"
          env_vars:
            - name: EXPECT_LINK_INFO
              value: dynamic
          commands_file: semaphore_commands.sh
 